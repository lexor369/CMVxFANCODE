<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="referrer" content="no-referrer">
  <title>CMV LIVE Player</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    #player-container {
      width: 100%;
      height: 100vh;
      background: black;
    }
    .plyr { height: 100%; }
    .telegram-modal {
      display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
      display: flex; justify-content: center; align-items: center;
    }
    .modal-box {
      background: linear-gradient(135deg, #2a2a3e 0%, #1f1f2b 100%); color: white;
      padding: 25px 30px; border-radius: 16px; text-align: center; width: 90%; max-width: 350px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .modal-box h3 { margin: 0 0 15px; font-size: 1.4rem; font-weight: 700; line-height: 1.4; }
    .modal-box p { margin: 0 0 20px; font-size: 0.95rem; color: #b0b0c0; }
    .modal-buttons { display: flex; flex-direction: column; gap: 12px; }
    .modal-btn {
      padding: 13px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600;
      cursor: pointer; text-decoration: none; transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .join-btn {
      background: linear-gradient(90deg, #0088cc, #00aaff); color: white;
      box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3);
    }
    .join-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 150, 255, 0.4); }
    .joined-btn {
      background-color: rgba(255, 255, 255, 0.1); color: #ddd; border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .joined-btn:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
    .error-message { color: white; text-align: center; padding-top: 40vh; font-size: 1.2rem; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <div id="telegram-modal" class="telegram-modal">
    <div class="modal-box">
      <h3><i class="fab fa-telegram-plane"></i> Join Our Channel</h3>
      <p>Get all match updates and links directly on our Telegram channel!</p>
      <div class="modal-buttons">
        <a id="join-btn" class="modal-btn join-btn" href="https://t.me/cricketmemesverse873" target="_blank">
          <i class="fas fa-paper-plane"></i> Join Now
        </a>
        <button id="already-joined-btn" class="modal-btn joined-btn">
          <i class="fas fa-check"></i> Already Joined
        </button>
      </div>
    </div>
  </div>

  <div id="player-container">
      <video id="player" playsinline controls></video>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.min.js"></script>

  <script>
    const modal = document.getElementById('telegram-modal');
    const joinBtn = document.getElementById('join-btn');
    const alreadyJoinedBtn = document.getElementById('already-joined-btn');
    const playerContainer = document.getElementById('player-container');
    const video = document.getElementById('player');
    const rawStreamUrl = new URLSearchParams(window.location.search).get("stream");
    let player = null;
    let hls = null;

    function showError(message) {
      console.error("Player Error:", message);
      if (hls) { try { hls.destroy(); hls = null; } catch(e){} }
      if (player) { try { player.destroy(); player = null; } catch(e){} }
      playerContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function setupAndLoadPlayer() {
      console.log("Setting up player...");
      if (!rawStreamUrl) {
        showError("Error: No stream URL provided.");
        return;
      }
      
      const proxyStreamUrl = `/proxy?url=${encodeURIComponent(rawStreamUrl)}`;
      console.log("Using proxy URL for main manifest:", proxyStreamUrl);
      
      const plyrOptions = {
        controls: ['play-large', 'play', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
        quality: { default: 576, options: [240, 360, 480, 576, 720, 1080] } 
      };

      try {
          if (player) { player.destroy(); } 
          player = new Plyr(video, plyrOptions);
          console.log("Plyr initialized.");

          if (Hls.isSupported()) {
            console.log("HLS.js supported. Configuring and loading source...");
            if (hls) { hls.destroy(); } 
            
            // --- CORRECTED HLS.js Loader Configuration ---
            hls = new Hls({
                loader: class CustomLoader extends Hls.DefaultConfig.loader {
                    constructor(config) {
                        super(config);
                        this.proxyBaseUrl = '/proxy?url='; 
                    }

                    load(context, config, callbacks) {
                        let originalUrl = context.url; // URL requested by HLS
                        let urlToProxy = originalUrl;

                        // --- FIX: Check if originalUrl ALREADY starts with our proxy ---
                        if (originalUrl.startsWith(this.proxyBaseUrl) || originalUrl.startsWith('/proxy?')) {
                            console.log("URL already proxied, using as is:", originalUrl);
                            // It's already proxied (likely the main manifest), load it directly
                             super.load(context, config, callbacks);
                             return; 
                        }

                        // --- FIX: Check if it's an ABSOLUTE URL (starts with http) but NOT proxied yet ---
                        if (originalUrl.startsWith('http')) {
                            console.log("Absolute URL found, needs proxying:", originalUrl);
                            urlToProxy = originalUrl; // This is the URL we need to proxy
                        }
                        // --- FIX: Check if it's a RELATIVE URL ---
                        else if (!originalUrl.startsWith('/')) { // Simple check for relative path
                           console.log(`Relative URL found: ${originalUrl}. Resolving...`);
                           try {
                                const base = new URL(rawStreamUrl); // Base is the ORIGINAL stream URL
                                const absoluteSegmentUrl = new URL(originalUrl, base.origin + base.pathname.substring(0, base.pathname.lastIndexOf('/') + 1)).toString();
                                console.log(`Resolved absolute: ${absoluteSegmentUrl}`);
                                urlToProxy = absoluteSegmentUrl; // This is the URL we need to proxy
                            } catch (e) {
                                console.error("Error resolving relative URL:", e, "Original:", originalUrl);
                                // If resolving fails, try proxying the original relative path directly (might work sometimes)
                                // urlToProxy = originalUrl; 
                                // OR: Fail gracefully
                                callbacks.onError({ response: { code: 404, text: 'Failed to resolve relative URL' } }, context, null);
                                return;
                            }
                        } else {
                            // It's some other kind of URL (e.g., starts with '/', data:), don't proxy
                            console.log("Unhandled URL type, loading directly:", originalUrl);
                            super.load(context, config, callbacks);
                            return;
                        }

                        // --- Apply proxy ONLY if needed ---
                        context.url = this.proxyBaseUrl + encodeURIComponent(urlToProxy);
                        console.log("Proxying final URL:", context.url); 
                        super.load(context, config, callbacks);
                    }
                }
            });

            hls.loadSource(proxyStreamUrl); // Load the main manifest (first request goes through proxy)
            hls.attachMedia(video);

            hls.once(Hls.Events.MANIFEST_PARSED, (event, data) => {
              console.log("HLS Manifest Parsed (levels available):", data.levels);
               if (player && player.elements && player.elements.container) { 
                  const availableQualities = hls.levels.map(level => level.height).filter((v, i, a) => a.indexOf(v) === i); 
                  const defaultQuality = availableQualities.includes(576) ? 576 : (availableQualities.length > 0 ? availableQualities[0] : 360);
                  
                  player.options.quality = {
                    default: defaultQuality,
                    options: availableQualities.length > 0 ? availableQualities : [defaultQuality],
                    forced: true,
                    onChange: (quality) => {
                        console.log("Quality changing to:", quality);
                        let newLevel = hls.levels.findIndex((level) => level.height === quality);
                         if(newLevel === -1) { 
                            newLevel = hls.levels.reduce((prev, curr, index) => {
                                return (Math.abs(curr.height - quality) < Math.abs(hls.levels[prev].height - quality) ? index : prev);
                             }, 0);
                         }
                        console.log("Switching HLS level index:", newLevel);
                        hls.currentLevel = newLevel;
                    },
                  };
                  console.log("Plyr quality options updated.");
              } else {
                 console.log("Plyr instance not found when trying to update quality.");
              }
               player.play().catch(e => console.warn("Autoplay prevented:", e)); 
               setupOrientationLock(player); 
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
              console.error('HLS.js Error:', data); 
              if (data.fatal) {
                 let errorDetails = data.details || data.type || "Unknown HLS Error";
                 if (data.response) { 
                     errorDetails += ` (Status: ${data.response.code})`;
                 }
                 showError(`Could not load stream: ${errorDetails}`);
                 if(hls) { hls.destroy(); hls = null; }
              } else {
                  console.warn("Non-fatal HLS error:", data.details || data.type);
              }
            });

          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            console.log("Native HLS supported. Setting source...");
            video.src = proxyStreamUrl; 
            player.play().catch(e => console.warn("Autoplay prevented:", e));
             setupOrientationLock(player); 

          } else {
            showError("Your browser does not support HLS playback.");
          }
      } catch (error) {
          console.error("Critical error setting up player:", error);
          showError("An error occurred initializing the player.");
      }
    }

    function setupOrientationLock(plyrInstance) {
        if (!plyrInstance) return;
        plyrInstance.on('enterfullscreen', () => {
             console.log("Entering fullscreen");
            if (screen.orientation?.lock) {
              screen.orientation.lock('landscape').catch(err => console.warn('Orientation lock failed:', err));
            }
        });
    }

    // --- Modal Logic ---
    modal.style.display = 'flex';

    alreadyJoinedBtn.addEventListener('click', () => {
      console.log("Already Joined clicked.");
      modal.style.display = 'none';
      setupAndLoadPlayer(); 
    });

    joinBtn.addEventListener('click', () => {
       console.log("Join clicked.");
      setTimeout(() => {
        if (modal.style.display !== 'none') { 
            modal.style.display = 'none';
            setupAndLoadPlayer(); 
        }
      }, 1000); 
    });
    
    // --- Anti-iframe ---
    if (window.top !== window.self) {
      document.addEventListener('DOMContentLoaded', function () {
        showError('Content cannot be embedded.');
      });
    }
    
  </script>
</body>
</html>

